<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ashley Jeffs">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Batching - Benthos</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css">
        <link href="../style/blobfish.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-135959729-3', 'docs.benthos.dev');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
  <a class="navbar-brand" href="https://www.benthos.dev">Benthos</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="/">Home</a>
                            </li>
                            <li >
                                <a href="../cookbooks/">Cookbooks</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Components <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../inputs/">Inputs</a>
</li>
                                    
<li >
    <a href="../buffers/">Buffers</a>
</li>
                                    
<li >
    <a href="../processors/">Processors</a>
</li>
                                    
<li >
    <a href="../conditions/">Conditions</a>
</li>
                                    
<li >
    <a href="../outputs/">Outputs</a>
</li>
                                    
<li >
    <a href="../caches/">Caches</a>
</li>
                                    
<li >
    <a href="../rate_limits/">Rate Limits</a>
</li>
                                    
<li >
    <a href="../metrics/">Metrics</a>
</li>
                                    
<li >
    <a href="../tracers/">Tracers</a>
</li>
                                    
<li >
    <a href="../logger/">Logger</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../getting_started/">Getting Started</a>
</li>
                                    
<li >
    <a href="../serverless/">Serverless</a>
</li>
                                    
<li >
    <a href="../configuration/">Configuration</a>
</li>
                                    
<li >
    <a href="../configuration_testing/">Configuration Testing</a>
</li>
                                    
<li >
    <a href="../config_interpolation/">Config Interpolation</a>
</li>
                                    
<li >
    <a href="../pipeline/">Processing Pipelines</a>
</li>
                                    
<li class="active">
    <a href="./">Batching</a>
</li>
                                    
<li >
    <a href="../error_handling/">Error Handling</a>
</li>
                                    
<li >
    <a href="../performance_tuning/">Performance Tuning</a>
</li>
                                    
<li >
    <a href="../monitoring/">Monitoring</a>
</li>
                                    
<li >
    <a href="../sync_responses/">Synchronous Responses</a>
</li>
                                    
<li >
    <a href="../workflows/">Workflows</a>
</li>
                                    
<li >
    <a href="../streams/">Streams Mode</a>
</li>
                                    
<li >
    <a href="../examples/">Applied Examples</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
    <li class="nav-item">
      <a rel="prev" href="../pipeline/" class="nav-link">
        <i class="fa fa-arrow-left"></i>
      </a>
    </li>
    <li class="nav-item">
      <a rel="next" href="../error_handling/" class="nav-link">
        <i class="fa fa-arrow-right"></i>
      </a>
    </li>
    <li class="nav-item">
      <a href="https://github.com/Jeffail/benthos/" class="nav-link">
        <i class="fa fa-github"></i> Code
      </a>
    </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#message-batching">Message Batching</a></li>
            <li><a href="#performance">Performance</a></li>
            <li><a href="#grouped-message-processing">Grouped Message Processing</a></li>
            <li><a href="#compatibility">Compatibility</a></li>
            <li><a href="#batch-policy">Batch Policy</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="message-batching">Message Batching</h1>
<p>Benthos is able to join sources and sinks with sometimes conflicting batching behaviours without sacrificing its strong delivery guarantees. It's also able to perform powerful processing functions across batches of messages such as grouping, archiving and reduction. Therefore, batching within Benthos is a mechanism that serves multiple purposes:</p>
<ol>
<li><a href="#performance">Performance (throughput)</a></li>
<li><a href="#grouped-message-processing">Grouped message processing</a></li>
<li><a href="#compatibility">Compatibility (mixing multi and single part message protocols)</a></li>
</ol>
<h2 id="performance">Performance</h2>
<p>For most users the only benefit of batching messages is improving throughput over your output protocol. For some protocols this can happen in the background and requires no configuration from you. However, if an output has a <code>batching</code> configuration block this means it benefits from batching and requires you to specify how you'd like your batches to be formed by configuring a <a href="#batch-policy">batching policy</a>:</p>
<pre><code class="yaml">output:
  foo:
    # Either send batches when they reach 10 messages or when 100ms has passed
    # since the last batch.
    batching:
      count: 10
      period: 100ms
</code></pre>

<p>However, a small number of inputs such as <a href="../inputs/#kafka"><code>kafka</code></a> must be consumed sequentially (in this case by partition) and therefore benefit from specifying your batch policy at the input level instead:</p>
<pre><code class="yaml">input:
  kafka:
    addresses: [ todo:9092 ]
    topic: baz
    batching:
      count: 10
      period: 100ms

output:
  type: foo
</code></pre>

<p>Inputs that behave this way are documented as such and have a <code>batching</code> configuration block.</p>
<p>Sometimes you may prefer to create your batches before processing in order to benefit from <a href="#grouped-message-processing">batch wide processing</a>, in which case if your input doesn't already support <a href="#batch-policy">a batch policy</a> you can instead use a <a href="../inputs/#broker"><code>broker</code></a>, which also allows you to combine inputs with a single batch policy:</p>
<pre><code class="yaml">input:
  broker:
    inputs:
      - type: foo
      - type: bar
    batching:
      count: 50
      period: 500ms
</code></pre>

<p>This also works the same with <a href="../outputs/#broker">output brokers</a>.</p>
<h2 id="grouped-message-processing">Grouped Message Processing</h2>
<p>One of the more powerful features of Benthos is that all processors are "batch aware", which means processors that operate on single messages can be configured using the <code>parts</code> field to only operate on select messages of a batch:</p>
<pre><code class="yaml">pipeline:
  processors:
    # This processor only acts on the first message of a batch
    - jmespath:
        parts: [ 0 ]
        query: &quot;{ nested: @, links: join(', ', data.urls) }&quot;
</code></pre>

<p>And some <a href="../config_interpolation/#functions">function interpolation</a> operations are evaluated batch wide:</p>
<pre><code class="yaml">pipeline:
  processors:
    # Set the field `common_foo` of every message of the batch to the value of
    # `body.source_id` of the last message of the batch.
    - json:
        operator: set
        path: common_foo
        value: &quot;${!json_field:body.source_id,-1}&quot;
</code></pre>

<p>You can also avoid this behaviour with the <a href="../processors/#for_each"><code>for_each</code> processor</a>.</p>
<p>There's a vast number of processors that specialise in operations across batches such as <a href="../processors/#group_by">grouping</a>, <a href="../processors/#archive">archiving</a>, <a href="../processors/#merge_json">joining</a> and more. For example, the following processors group a batch of messages according to a metadata field and compresses them into separate <code>.tar.gz</code> archives:</p>
<pre><code class="yaml">pipeline:
  processors:
  - group_by_value:
      value: ${!metadata:kafka_partition}
  - archive:
      format: tar
  - compress:
      algorithm: gzip

output:
  s3:
    bucket: TODO
    path: docs/${!metadata:kafka_partition}/${!count:files}-${!timestamp_unix_nano}.tar.gz
</code></pre>

<h2 id="compatibility">Compatibility</h2>
<p>Benthos is able to read and write over protocols that support multiple part messages, and all payloads travelling through Benthos are represented as a multiple part message. Therefore, all components within Benthos are able to work with multiple parts in a message as standard.</p>
<p>When messages reach an output that <em>doesn't</em> support multiple parts the message is broken down into an individual message per part, and then one of two behaviours happen depending on the output. If the output supports batch sending messages then the collection of messages are sent as a single batch. Otherwise, Benthos falls back to sending the messages sequentially in multiple, individual requests.</p>
<p>This behaviour means that not only can multiple part message protocols be easily matched with single part protocols, but also the concept of multiple part messages and message batches are interchangeable within Benthos.</p>
<h3 id="shrinking-batches">Shrinking Batches</h3>
<p>A message batch (or multiple part message) can be broken down into smaller batches using the <a href="../processors/#split"><code>split</code></a> processor:</p>
<pre><code class="yaml">input:
  # Consume messages that arrive in three parts.
  type: foo
  processors:
    # Drop the third part
    - select_parts:
        parts: [ 0, 1 ]
    # Then break our message parts into individual messages
    - split:
        count: 1
</code></pre>

<p>This is also useful when your input source creates batches that are too large for your output protocol:</p>
<pre><code class="yaml">input:
  s3:
    bucket: todo

pipeline:
  processors:
    - decompress:
        algorith: gzip
    - unarchive:
        format: tar
    # Limit batch sizes to 5MB
    - split:
        byte_size: 5_000_000
</code></pre>

<h2 id="batch-policy">Batch Policy</h2>
<p>When an input component has a config field <code>batching</code> that means it supports a batch policy. This is a mechanism that allows you to configure exactly how your batching should work.</p>
<p>Batches are considered complete and will be flushed downstream when either of the following conditions are met:</p>
<ul>
<li>The <code>byte_size</code> field is non-zero and the total size of the batch in bytes matches or exceeds it (disregarding metadata.)</li>
<li>The <code>count</code> field is non-zero and the total number of messages in the batch matches or exceeds it.</li>
<li>A message added to the batch causes the <a href="../conditions/"><code>condition</code></a> to resolve to <code>true</code>.</li>
<li>The <code>period</code> field is non-empty and the time since the last batch exceeds its value.</li>
</ul>
<p>This allows you to combine conditions:</p>
<pre><code class="yaml">output:
  foo:
    # Either send batches when they reach 10 messages or when 100ms has passed
    # since the last batch.
    batching:
      count: 10
      period: 100ms
</code></pre>

<p>During shutdown any remaining messages waiting for a batch to complete will be flushed down the pipeline.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
